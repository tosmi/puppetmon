#!/bin/env ruby

# maximum age of the agent lock file in seconds
$MAX_AGE = 43200

class PuppetMonitor
  attr_reader :state_dir

  def restart
    raise NotImplementedError
  end

  @state_dir           = '/var/lib/puppet/state'
  @state_dir           = ENV['PUPPETAGENT_STATE_DIR'] if ENV['PUPPETAGENT_STATE_DIR']
  @agent_lock_filename = File.join(@state_dir, 'agent_catalog_run.lock')
end

class SolarisPuppetMonitor < PuppetMonitor
  def restart
    `/usr/sbin/svcadm restart puppet`
  end
end

class AIXPuppetMonitor < PuppetMonitor
  def restart
    `/etc/rc.d/init.d/puppet restart`
  end
end

class LinuxPuppetMonitor < Puppetmonitor
  def restart
    `/sbin/service puppet restart`
  end
end

class Context

  def initialize(puppetmonitor)
    @puppetmonitor = puppetmonitor.new
  end

  def restart
    @puppetmonitor.restart
  end
end

if File.exists?(agent_lock)
  lastmodified = File.stat(agent_lock).mtime
  if Time.now - lastmodified > $MAX_AGE
    puts 'here'
  end
end
