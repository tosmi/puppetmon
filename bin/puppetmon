#!/bin/env ruby

# maximum age of the agent lock file in seconds
$MAX_AGE  = 43200

#if restarting the agent fails, whom should we contact?
$MAILADDR = 'anton.schmidbauer@s-itsolutions.at'


require 'logger'
$logger       = Logger.new(STDOUT)
$logger.level = Logger::DEBUG


module PuppetMonitor

  class BasePuppetMonitor
    attr_reader :state_dir, :agent_lock, :hostname

    def initialize()
      @state_dir  = '/var/lib/puppet/state'
      @state_dir  = ENV['PUPPETAGENT_STATE_DIR'] if ENV['PUPPETAGENT_STATE_DIR']
      @agent_lock = File.join(@state_dir, 'agent_catalog_run.lock')
      @hostname   = `hostname`.chomp()
    end

    def restart
      raise NotImplementedError
    end

    def status_ok?
      raise NotImplementedError
    end

    def lock_older_than?(age)
      $logger.debug("check if #{@agent_lock} is older than #{age}")
      if File.exists?(@agent_lock)
        lastmodified = File.stat(@agent_lock).mtime
        if Time.now - lastmodified > age
          $logger.debug("#{@agent_lock} is older than #{age}")
          return true
        end
      end

      return false
    end

    def kill_stale_agent
      pid = get_agent_pid
      $logger.debug("killing stale agent with pid #{pid}")
      Process.kill('TERM', pid)
    end

    def get_agent_pid
      if File.exists?(@agent_lock)
        pid = File.open(@agent_lock).read
        pid.chomp.to_i
      end
    end
  end

  class SunOS < BasePuppetMonitor
    def restart
      `/usr/sbin/svcadm restart puppet`
    end

    def status_ok?
      `/usr/sbin/svcs puppet`
    end
  end

  class AIX < BasePuppetMonitor
    def restart
      `/etc/rc.d/init.d/puppet restart`
    end

    def status_ok?
      `/etc/rc.d/init.d/puppet status`
    end
  end

  class Linux < BasePuppetMonitor
    def restart
      `/sbin/service puppet restart`
    end

    def status_ok?
      `/sbin/service puppet status`
    end
  end
end

class GetAPuppetMonitor
  def initialize()
    case `uname -s`.chomp
    when 'Linux'
      @monimp = PuppetMonitor::Linux.new

    when 'SunOS'
      @monimp = PuppetMonitor::SunOS.new

    when 'AIX'
      @monimp = PuppetMonitor::AIX.new
    end
  end

  def restart
    $logger.debug("going restart the puppet agent")
    @monimp.restart
    $logger.debug("waiting 5 seconds to give the agent time for startup")
    sleep 5
  end

  def method_missing(meth, *args, &block)
    @monimp.send(meth.to_sym, *args, &block)
  end
end

def send_mail
end

#-----
# MAIN()
#
puppet = GetAPuppetMonitor.new
if puppet.lock_older_than?($MAX_AGE)
  puppet.kill_stale_agent
end

puppet.restart
if not puppet.status_ok?
  $logger.error("restarting the agent failed")
  send_mail($MAILADDR, "restarting the agent on #{mon.hostname} failed")
end
